name: Build iOS App
on: [push]

jobs:
  build:
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v3

      - name: Setup Project Structure
        run: |
          mkdir -p Randomizer/Sources/Randomizer
          # Создаем файл входа (App), который запускает твой ContentView
          echo 'import SwiftUI
          @main struct RandomApp: App {
              var body: some Scene { WindowGroup { ContentView() } }
          }' > Randomizer/Sources/Randomizer/App.swift
          
          # Перемещаем твой код в рабочую папку
          mv ContentView.swift Randomizer/Sources/Randomizer/
          
          # Создаем файл описания проекта
          echo '// swift-tools-version:5.5
          import PackageDescription
          let package = Package(
              name: "Randomizer",
              platforms: [.iOS(.v15)],
              products: [.executable(name: "Randomizer", targets: ["Randomizer"])],
              targets: [.executableTarget(name: "Randomizer", path: "Sources/Randomizer")]
          )' > Randomizer/Package.swift

      - name: Build for iOS
        run: |
          cd Randomizer
          xcodebuild build -scheme Randomizer \
            -destination "generic/platform=iOS" \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            clean

      - name: Package IPA
        run: |
          mkdir -p Payload
          # Ищем скомпилированное приложение и упаковываем
          APP_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -name "*.app" | head -n 1)
          cp -r "$APP_PATH" Payload/
          zip -r Randomizer.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: iOS-Package
          path: Randomizer.ipa
